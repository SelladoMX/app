app-id: com.selladomx.SelladoMX
runtime: org.kde.Platform
runtime-version: '6.7'
sdk: org.kde.Sdk
command: selladomx

finish-args:
  # Filesystem - PDFs, certs, output, settings
  - --filesystem=home

  # Network - API, TSA, GitHub, OCSP/CRL
  - --share=network

  # Display
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc

  # D-Bus for desktop integration
  - --socket=session-bus
  - --talk-name=org.freedesktop.portal.Desktop
  - --talk-name=org.freedesktop.portal.OpenURI

  # Settings persistence
  - --persist=.config/SelladoMX

modules:
  # Module 1: Poetry (build-time only)
  - name: poetry
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} poetry
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/7d/b7/4c242ff85f6263f411060336ef7370e444b1718de1122d0c145e92170b01/poetry-2.3.2.tar.gz
        sha256: 6e81526ae99a4f07f75174600bfe8b73e74c786dc18c9d1ce1800dd6f807414b

  # Module 2: Main application with dependencies
  - name: selladomx
    buildsystem: simple
    build-commands:
      # Install dependencies using Poetry
      - poetry config virtualenvs.create false
      - poetry install --only main --no-root

      # Build and install the application
      - poetry build
      - pip3 install --prefix=${FLATPAK_DEST} --no-deps dist/*.whl

      # Install desktop file
      - install -Dm644 assets/selladomx.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key=Exec --set-value="selladomx %u" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key=Icon --set-value=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop

      # Install icon
      - install -Dm644 assets/selladomx.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png

      # Install AppStream metadata
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml

      # Install launcher script
      - install -Dm755 scripts/flatpak-launcher.sh ${FLATPAK_DEST}/bin/selladomx

    sources:
      - type: dir
        path: .
